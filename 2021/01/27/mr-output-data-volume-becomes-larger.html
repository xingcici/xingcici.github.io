<!DOCTYPE html>
<html lang=zh>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="renderer" content="webkit">
  <meta http-equiv="Cache-Control" content="no-transform" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="format-detection" content="telephone=no,email=no,adress=no">
  <!-- Color theme for statusbar -->
  <meta name="theme-color" content="#000000" />
  <!-- 强制页面在当前窗口以独立页面显示,防止别人在框架里调用页面 -->
  <meta http-equiv="window-target" content="_top" />
  
  
  <title>MR产出数据体积变大问题 | 一方天地</title>
  <meta name="description" content="一、现象前段时间在做数据同步任务的切换，在切换到MR后，总共36个任务，10个变小，16个不变，10个变大，而且变大的体积基本上都是翻倍。另外公司的存储空间当时较为紧张，所以需要解决这个体积增大的问题。 下图是用 parquet-tools 解析文件获得到，可以看到，左侧 outscan 比 右侧 mr 在好几个column上压缩率都高不少 ods_trd_buyer_order_app_orde">
<meta property="og:type" content="article">
<meta property="og:title" content="MR产出数据体积变大问题">
<meta property="og:url" content="http://xingcici.github.io/2021/01/27/mr-output-data-volume-becomes-larger.html">
<meta property="og:site_name" content="一方天地">
<meta property="og:description" content="一、现象前段时间在做数据同步任务的切换，在切换到MR后，总共36个任务，10个变小，16个不变，10个变大，而且变大的体积基本上都是翻倍。另外公司的存储空间当时较为紧张，所以需要解决这个体积增大的问题。 下图是用 parquet-tools 解析文件获得到，可以看到，左侧 outscan 比 右侧 mr 在好几个column上压缩率都高不少 ods_trd_buyer_order_app_orde">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/xingcici/oss@master/uPic/image-20210127165937262.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/xingcici/oss@master/uPic/image-20210127165912092.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/xingcici/oss@master/uPic/image-20210127165049558.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/xingcici/oss@master/uPic/image-20210127165125612.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/xingcici/oss@master/uPic/image-20210127165142007.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/xingcici/oss@master/uPic/image-20210127165848742.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/xingcici/oss@master/uPic/image-20210127165221964.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/xingcici/oss@master/uPic/image-20210127165830347.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/xingcici/oss@master/uPic/image-20210127165246366.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/xingcici/oss@master/uPic/image-20210127165814330.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/xingcici/oss@master/uPic/image-20210127165310098.png">
<meta property="article:published_time" content="2021-01-27T08:45:19.027Z">
<meta property="article:modified_time" content="2021-01-27T09:04:17.617Z">
<meta property="article:author" content="行词">
<meta property="article:tag" content="hadoop">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/xingcici/oss@master/uPic/image-20210127165937262.png">
  <!-- Canonical links -->
  <link rel="canonical" href="http://xingcici.github.io/2021/01/27/mr-output-data-volume-becomes-larger.html">
  
    <link rel="alternate" href="/atom.xml" title="一方天地" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png" type="image/x-icon">
  
  
<link rel="stylesheet" href="/css/style.css">

  
  
  
  
<meta name="generator" content="Hexo 4.2.1"></head>


<body class="main-center theme-black" itemscope itemtype="http://schema.org/WebPage">
  <header class="header" itemscope itemtype="http://schema.org/WPHeader">
  <div class="slimContent">
    <div class="navbar-header">
      
      
      <div class="profile-block text-center">
        <a id="avatar" href="https://github.com/xingcici" target="_blank">
          <img class="img-circle img-rotate" src="/images/avatar.jpg" width="200" height="200">
        </a>
        <h2 id="name" class="hidden-xs hidden-sm">行词</h2>
        <h3 id="title" class="hidden-xs hidden-sm hidden-md">中间件</h3>
        <small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i> Hangzhou, China</small>
      </div>
      
      <div class="search" id="search-form-wrap">

    <form class="search-form sidebar-form">
        <div class="input-group">
            <input type="text" class="search-form-input form-control" placeholder="搜索" />
            <span class="input-group-btn">
                <button type="submit" class="search-form-submit btn btn-flat" onclick="return false;"><i class="icon icon-search"></i></button>
            </span>
        </div>
    </form>
    <div class="ins-search">
  <div class="ins-search-mask"></div>
  <div class="ins-search-container">
    <div class="ins-input-wrapper">
      <input type="text" class="ins-search-input" placeholder="想要查找什么..." x-webkit-speech />
      <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
    </div>
    <div class="ins-section-wrapper">
      <div class="ins-section-container"></div>
    </div>
  </div>
</div>


</div>
      <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    </div>
    <nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation">
      <ul class="nav navbar-nav main-nav menu-highlight">
        
        
        <li class="menu-item menu-item-home">
          <a href="/.">
            
            <i class="icon icon-home-fill"></i>
            
            <span class="menu-title">首页</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-archives">
          <a href="/archives">
            
            <i class="icon icon-archives-fill"></i>
            
            <span class="menu-title">归档</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-categories">
          <a href="/categories">
            
            <i class="icon icon-folder"></i>
            
            <span class="menu-title">分类</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-tags">
          <a href="/tags">
            
            <i class="icon icon-tags"></i>
            
            <span class="menu-title">标签</span>
          </a>
        </li>
        
      </ul>
      
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/xingcici" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
        <li><a href="/atom.xml" target="_blank" title="Rss" data-toggle=tooltip data-placement=top><i class="icon icon-rss"></i></a></li>
        
    </ul>

    </nav>
  </div>
</header>

  
    <aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    
      <div class="widget">
    <h3 class="widget-title">公告</h3>
    <div class="widget-body">
        <div id="board">
            <div class="content">
                <p>记录一些学习和工作的一点点思考</p>
            </div>
        </div>
    </div>
</div>

    
      
  <div class="widget">
    <h3 class="widget-title">分类</h3>
    <div class="widget-body">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/">中间件</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/">分布式</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%95%B0%E6%8D%AE%E6%99%BA%E8%83%BD/">数据智能</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%97%A5%E5%B8%B8%E9%97%AE%E9%A2%98/">日常问题</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%9D%82%E4%B8%83%E6%9D%82%E5%85%AB/">杂七杂八</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1/">架构设计</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%BA%90%E7%A0%81/">源码</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%BC%96%E7%A8%8B/">编程</a><span class="category-list-count">1</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">标签</h3>
    <div class="widget-body">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/JDK/" rel="tag">JDK</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MQ/" rel="tag">MQ</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Netty/" rel="tag">Netty</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RocketMQ/" rel="tag">RocketMQ</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Zookeeper/" rel="tag">Zookeeper</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dubbo/" rel="tag">dubbo</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hadoop/" rel="tag">hadoop</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/" rel="tag">linux</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%8F%8D%E5%B0%84/" rel="tag">反射</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%AF%86%E7%A0%81%E5%AD%A6/" rel="tag">密码学</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%AE%97%E6%B3%95/" rel="tag">算法</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BD%91%E7%BB%9C/" rel="tag">网络</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%93%BE%E8%B7%AF%E8%BF%BD%E8%B8%AA/" rel="tag">链路追踪</a><span class="tag-list-count">1</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">标签云</h3>
    <div class="widget-body tagcloud">
      <a href="/tags/JDK/" style="font-size: 13px;">JDK</a> <a href="/tags/MQ/" style="font-size: 13px;">MQ</a> <a href="/tags/Netty/" style="font-size: 13.5px;">Netty</a> <a href="/tags/RocketMQ/" style="font-size: 14px;">RocketMQ</a> <a href="/tags/Zookeeper/" style="font-size: 13px;">Zookeeper</a> <a href="/tags/dubbo/" style="font-size: 13px;">dubbo</a> <a href="/tags/hadoop/" style="font-size: 13px;">hadoop</a> <a href="/tags/linux/" style="font-size: 13px;">linux</a> <a href="/tags/%E5%8F%8D%E5%B0%84/" style="font-size: 13px;">反射</a> <a href="/tags/%E5%AF%86%E7%A0%81%E5%AD%A6/" style="font-size: 13px;">密码学</a> <a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size: 13px;">算法</a> <a href="/tags/%E7%BD%91%E7%BB%9C/" style="font-size: 13.5px;">网络</a> <a href="/tags/%E9%93%BE%E8%B7%AF%E8%BF%BD%E8%B8%AA/" style="font-size: 13px;">链路追踪</a>
    </div>
  </div>

    
      
  <div class="widget">
    <h3 class="widget-title">归档</h3>
    <div class="widget-body">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">一月 2021</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">九月 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">七月 2020</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">六月 2020</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">四月 2020</a><span class="archive-list-count">3</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget-body">
      <ul class="recent-post-list list-unstyled no-thumbnail">
        
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/">中间件</a>
              </p>
              <p class="item-title">
                <a href="/2021/01/27/decentralized-message-queue-meta-mq.html" class="title">去中心化消息队列 Meta MQ</a>
              </p>
              <p class="item-date">
                <time datetime="2021-01-27T12:25:24.885Z" itemprop="datePublished">2021-01-27</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/%E6%95%B0%E6%8D%AE%E6%99%BA%E8%83%BD/">数据智能</a>
              </p>
              <p class="item-title">
                <a href="/2021/01/27/mr-output-data-volume-becomes-larger.html" class="title">MR产出数据体积变大问题</a>
              </p>
              <p class="item-date">
                <time datetime="2021-01-27T08:45:19.027Z" itemprop="datePublished">2021-01-27</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/">中间件</a>
              </p>
              <p class="item-title">
                <a href="/2020/09/10/skywalking-660-compatibility-issues-with-arthas.html" class="title">Skywalking 6.6.0对arthas的兼容性问题</a>
              </p>
              <p class="item-date">
                <time datetime="2020-09-10T09:08:08.549Z" itemprop="datePublished">2020-09-10</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/%E6%9D%82%E4%B8%83%E6%9D%82%E5%85%AB/">杂七杂八</a>
              </p>
              <p class="item-title">
                <a href="/2020/07/13/zero-knowledge-proof.html" class="title">零知识证明</a>
              </p>
              <p class="item-date">
                <time datetime="2020-07-13T10:58:34.892Z" itemprop="datePublished">2020-07-13</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/%E6%BA%90%E7%A0%81/">源码</a>
              </p>
              <p class="item-title">
                <a href="/2020/07/13/futuretask.html" class="title">FutureTask</a>
              </p>
              <p class="item-date">
                <time datetime="2020-07-13T09:44:52.627Z" itemprop="datePublished">2020-07-13</time>
              </p>
            </div>
          </li>
          
      </ul>
    </div>
  </div>
  

    
  </div>
</aside>

  
  
<main class="main" role="main">
  <div class="content">
  <article id="post-MR产出数据体积变大问题" class="article article-type-post" itemscope itemtype="http://schema.org/BlogPosting">
    
    <div class="article-header">
      
        
  
    <h1 class="article-title" itemprop="name">
      MR产出数据体积变大问题
    </h1>
  

      
      <div class="article-meta">
        <span class="article-date">
    <i class="icon icon-calendar-check"></i>
	<a href="/2021/01/27/mr-output-data-volume-becomes-larger.html" class="article-date">
	  <time datetime="2021-01-27T08:45:19.027Z" itemprop="datePublished">2021-01-27</time>
	</a>
</span>
        
  <span class="article-category">
    <i class="icon icon-folder"></i>
    <a class="article-category-link" href="/categories/%E6%95%B0%E6%8D%AE%E6%99%BA%E8%83%BD/">数据智能</a>
  </span>

        
  <span class="article-tag">
    <i class="icon icon-tags"></i>
	<a class="article-tag-link" href="/tags/hadoop/" rel="tag">hadoop</a>
  </span>


        
	<span class="article-read hidden-xs">
	    <i class="icon icon-eye-fill" aria-hidden="true"></i>
	    <span id="busuanzi_container_page_pv">
			<span id="busuanzi_value_page_pv">0</span>
		</span>
	</span>


        <span class="post-comment"><i class="icon icon-comment"></i> <a href="/2021/01/27/mr-output-data-volume-becomes-larger.html#comments" class="article-comment-link">评论</a></span>
        
	
		<span class="post-wordcount hidden-xs" itemprop="wordCount">字数统计: 4.2k(字)</span>
	
	
		<span class="post-readcount hidden-xs" itemprop="timeRequired">阅读时长: 22(分)</span>
	

      </div>
    </div>
    <div class="article-entry marked-body" itemprop="articleBody">
      
        <h3 id="一、现象"><a href="#一、现象" class="headerlink" title="一、现象"></a>一、现象</h3><p>前段时间在做数据同步任务的切换，在切换到MR后，总共36个任务，10个变小，16个不变，10个变大，而且变大的体积基本上都是翻倍。另外公司的存储空间当时较为紧张，所以需要解决这个体积增大的问题。</p>
<p>下图是用 parquet-tools 解析文件获得到，可以看到，左侧 outscan 比 右侧 mr 在好几个column上压缩率都高不少</p>
<p>ods_trd_buyer_order_app_order_desc_info_d</p>
<p><img src="https://cdn.jsdelivr.net/gh/xingcici/oss@master/uPic/image-20210127165937262.png" alt="image-20210127165937262"></p>
<p>ods_itm_wd_inv_app_item_sku_d 则更加明显</p>
<p><img src="https://cdn.jsdelivr.net/gh/xingcici/oss@master/uPic/image-20210127165912092.png" alt="image-20210127165912092"></p>
<h3 id="二、研究"><a href="#二、研究" class="headerlink" title="二、研究"></a>二、研究</h3><h4 id="1、outscan（之前的同步方式，下面不再注释）和mr同步的区别。"><a href="#1、outscan（之前的同步方式，下面不再注释）和mr同步的区别。" class="headerlink" title="1、outscan（之前的同步方式，下面不再注释）和mr同步的区别。"></a>1、outscan（之前的同步方式，下面不再注释）和mr同步的区别。</h4><table>
<thead>
<tr>
<th align="left">outscan</th>
<th align="left">mr</th>
</tr>
</thead>
<tbody><tr>
<td align="left">直接 map hfile，没有reduce过程</td>
<td align="left">分别map text 增量和 parquet 全量，再进行reduce</td>
</tr>
<tr>
<td align="left">输出类为 AvroParquetOutputFormat</td>
<td align="left">输出类为 ParquetOutputFormat</td>
</tr>
<tr>
<td align="left"></td>
<td align="left"></td>
</tr>
</tbody></table>
<h4 id="2、尝试调整-parquet-参数"><a href="#2、尝试调整-parquet-参数" class="headerlink" title="2、尝试调整 parquet 参数"></a>2、尝试调整 parquet 参数</h4><p>先放一张 parquet 文件格式图</p>
<p><img src="https://cdn.jsdelivr.net/gh/xingcici/oss@master/uPic/image-20210127165049558.png" alt="image-20210127165049558"></p>
<p>可以看到 parquet 文件我们最需要关心的部分为 RowGroup、Column、 Page 。</p>
<p>当我们写 parquet 文件时，先会构造 RowGroup，然后根据不同的列构造不同的 Column，再分别在 Column 中构造 Page，然后向 Page 中写入数据，在每次写入时，会由 </p>
<p>accountForValueWritten() 判断是否需要 writePage ，如果需要的话会把当前 Column 中的 数据输出到一个 Collect，snappy 压缩也是在这个过程。当整个RowGroup到达整个 parquet.block.size 大小时，会把整个 RowGroup 输出到 hdfs。</p>
<table>
<thead>
<tr>
<th align="left">尝试调整的参数</th>
<th align="left">调整到的值</th>
<th align="left">对体积大小的影响</th>
</tr>
</thead>
<tbody><tr>
<td align="left">parquet.block.size</td>
<td align="left">1G</td>
<td align="left">基本无影响</td>
</tr>
<tr>
<td align="left"><code>parquet.page.size</code></td>
<td align="left">1-128M</td>
<td align="left">基本无影响</td>
</tr>
<tr>
<td align="left"><code>parquet.dictionary.page.size</code></td>
<td align="left">1-128M</td>
<td align="left">当只读 text 时，对体积约有20%的减小，在线上跑时，对体积基本无影响</td>
</tr>
<tr>
<td align="left"><code>io.compression.codec.snappy.buffersize</code></td>
<td align="left">1M</td>
<td align="left">基本无影响</td>
</tr>
<tr>
<td align="left"><code>io.file.buffer.size</code></td>
<td align="left">1M</td>
<td align="left">基本无影响</td>
</tr>
<tr>
<td align="left">输出类改为 AvroParquet</td>
<td align="left"></td>
<td align="left">基本无影响</td>
</tr>
<tr>
<td align="left">升级 parquet 版本</td>
<td align="left"></td>
<td align="left">基本无影响</td>
</tr>
<tr>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
</tr>
</tbody></table>
<h4 id="3、查看-outscan-和-mr-的日志区别"><a href="#3、查看-outscan-和-mr-的日志区别" class="headerlink" title="3、查看 outscan 和 mr 的日志区别"></a>3、查看 outscan 和 mr 的日志区别</h4><h5 id="a-outscan"><a href="#a-outscan" class="headerlink" title="a) outscan"></a>a) outscan</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">Dec 11, 2020 4:08:22 PM INFO: org.apache.parquet.hadoop.codec.CodecConfig: Compression: SNAPPY</span><br><span class="line">Dec 11, 2020 4:08:22 PM INFO: org.apache.parquet.hadoop.ParquetOutputFormat: Parquet block size to 134217728</span><br><span class="line">Dec 11, 2020 4:08:22 PM INFO: org.apache.parquet.hadoop.ParquetOutputFormat: Parquet page size to 1048576</span><br><span class="line">Dec 11, 2020 4:08:22 PM INFO: org.apache.parquet.hadoop.ParquetOutputFormat: Parquet dictionary page size to 1048576</span><br><span class="line">Dec 11, 2020 4:08:22 PM INFO: org.apache.parquet.hadoop.ParquetOutputFormat: Dictionary is on</span><br><span class="line">Dec 11, 2020 4:08:22 PM INFO: org.apache.parquet.hadoop.ParquetOutputFormat: Validation is off</span><br><span class="line">Dec 11, 2020 4:08:22 PM INFO: org.apache.parquet.hadoop.ParquetOutputFormat: Writer version is: PARQUET_1_0</span><br><span class="line">Dec 11, 2020 4:08:22 PM INFO: org.apache.parquet.hadoop.ParquetOutputFormat: Maximum row group padding size is 0 bytes</span><br><span class="line">Dec 11, 2020 4:08:54 PM INFO: org.apache.parquet.hadoop.InternalParquetRecordWriter: mem size 134,279,407 &gt; 134,217,728: flushing 1,035,273 records to disk.</span><br><span class="line">Dec 11, 2020 4:08:54 PM INFO: org.apache.parquet.hadoop.InternalParquetRecordWriter: Flushing mem columnStore to file. allocated memory: 134,097,175</span><br><span class="line">Dec 11, 2020 4:08:54 PM INFO: org.apache.parquet.hadoop.ColumnChunkPageWriteStore: written 4,122,796B for [auto_id] INT64: 1,035,273 values, 7,512,463B raw, 4,122,414B comp, 8 pages, encodings: [BIT_PACKED, PLAIN, RLE, PLAIN_DICTIONARY], dic &#123; 94,035 entries, 752,280B raw, 94,035B comp&#125;</span><br><span class="line">Dec 11, 2020 4:08:54 PM INFO: org.apache.parquet.hadoop.ColumnChunkPageWriteStore: written 5,925,458B for [id] INT64: 1,035,273 values, 8,282,248B raw, 5,925,075B comp, 8 pages, encodings: [BIT_PACKED, PLAIN, RLE]</span><br><span class="line">Dec 11, 2020 4:08:54 PM INFO: org.apache.parquet.hadoop.ColumnChunkPageWriteStore: written 4,213,757B for [item_id] INT64: 1,035,273 values, 7,507,266B raw, 4,213,375B comp, 8 pages, encodings: [BIT_PACKED, PLAIN, RLE, PLAIN_DICTIONARY], dic &#123; 83,192 entries, 665,536B raw, 83,192B comp&#125;</span><br><span class="line">Dec 11, 2020 4:08:54 PM INFO: org.apache.parquet.hadoop.ColumnChunkPageWriteStore: written 1,449,023B for [price] BINARY: 1,035,273 values, 1,548,410B raw, 1,448,622B comp, 9 pages, encodings: [BIT_PACKED, RLE, PLAIN_DICTIONARY], dic &#123; 13,877 entries, 135,544B raw, 13,877B comp&#125;</span><br><span class="line">Dec 11, 2020 4:08:54 PM INFO: org.apache.parquet.hadoop.ColumnChunkPageWriteStore: written 305,529B for [quantity] INT64: 1,035,273 values, 601,051B raw, 305,153B comp, 8 pages, encodings: [BIT_PACKED, RLE, PLAIN_DICTIONARY], dic &#123; 1,455 entries, 11,640B raw, 1,455B comp&#125;</span><br><span class="line">Dec 11, 2020 4:08:54 PM INFO: org.apache.parquet.hadoop.ColumnChunkPageWriteStore: written 1,585,004B for [total_price] BINARY: 1,035,273 values, 1,726,198B raw, 1,584,599B comp, 9 pages, encodings: [BIT_PACKED, RLE, PLAIN_DICTIONARY], dic &#123; 33,741 entries, 334,219B raw, 33,741B comp&#125;</span><br><span class="line">Dec 11, 2020 4:08:54 PM INFO: org.apache.parquet.hadoop.ColumnChunkPageWriteStore: written 25,257B for [cps_fee] BINARY: 1,035,273 values, 50,010B raw, 24,968B comp, 8 pages, encodings: [BIT_PACKED, RLE, PLAIN_DICTIONARY], dic &#123; 314 entries, 2,627B raw, 314B comp&#125;</span><br><span class="line">Dec 11, 2020 4:08:54 PM INFO: org.apache.parquet.hadoop.ColumnChunkPageWriteStore: written 2,715,269B for [item_sku_id] INT64: 1,035,273 values, 6,616,763B raw, 2,714,888B comp, 8 pages, encodings: [BIT_PACKED, PLAIN, RLE, PLAIN_DICTIONARY], dic &#123; 104,273 entries, 834,184B raw, 104,273B comp&#125;</span><br><span class="line">Dec 11, 2020 4:08:54 PM INFO: org.apache.parquet.hadoop.ColumnChunkPageWriteStore: written 6,605,807B for [add_time] BINARY: 1,035,273 values, 22,843,179B raw, 6,604,199B comp, 23 pages, encodings: [BIT_PACKED, PLAIN, RLE, PLAIN_DICTIONARY], dic &#123; 27,693 entries, 636,939B raw, 27,693B comp&#125;</span><br><span class="line">Dec 11, 2020 4:08:55 PM INFO: org.apache.parquet.hadoop.ColumnChunkPageWriteStore: written 4,098,234B for [order_id] INT64: 1,035,273 values, 7,490,983B raw, 4,097,852B comp, 8 pages, encodings: [BIT_PACKED, PLAIN, RLE, PLAIN_DICTIONARY], dic &#123; 76,367 entries, 610,936B raw, 76,367B comp&#125;</span><br><span class="line">Dec 11, 2020 4:08:55 PM INFO: org.apache.parquet.hadoop.ColumnChunkPageWriteStore: written 402B for [sk] BINARY: 1,035,273 values, 94B raw, 102B comp, 4 pages, encodings: [BIT_PACKED, RLE, PLAIN_DICTIONARY], dic &#123; 7 entries, 392B raw, 7B comp&#125;</span><br><span class="line">Dec 11, 2020 4:08:55 PM INFO: org.apache.parquet.hadoop.ColumnChunkPageWriteStore: written 5,835,688B for [item_sku_title] BINARY: 1,035,273 values, 12,055,000B raw, 5,834,969B comp, 13 pages, encodings: [BIT_PACKED, PLAIN, RLE, PLAIN_DICTIONARY], dic &#123; 23,553 entries, 567,428B raw, 23,553B comp&#125;</span><br><span class="line">Dec 11, 2020 4:08:55 PM INFO: org.apache.parquet.hadoop.ColumnChunkPageWriteStore: written 34,929,921B for [item_title] BINARY: 1,035,273 values, 67,065,375B raw, 34,918,001B comp, 65 pages, encodings: [BIT_PACKED, PLAIN, RLE, PLAIN_DICTIONARY], dic &#123; 9,636 entries, 720,750B raw, 9,636B comp&#125;</span><br><span class="line">Dec 11, 2020 4:08:55 PM INFO: org.apache.parquet.hadoop.ColumnChunkPageWriteStore: written 23,697,146B for [img_head] BINARY: 1,035,273 values, 62,188,305B raw, 23,689,804B comp, 61 pages, encodings: [BIT_PACKED, PLAIN, RLE, PLAIN_DICTIONARY], dic &#123; 11,114 entries, 692,307B raw, 11,114B comp&#125;</span><br><span class="line">Dec 11, 2020 4:08:55 PM INFO: org.apache.parquet.hadoop.ColumnChunkPageWriteStore: written 15,024,817B for [extend] BINARY: 1,035,273 values, 59,829,153B raw, 15,022,915B comp, 56 pages, encodings: [BIT_PACKED, PLAIN, RLE]</span><br><span class="line">Dec 11, 2020 4:08:55 PM INFO: org.apache.parquet.hadoop.ColumnChunkPageWriteStore: written 456B for [data_ver] INT64: 1,035,273 values, 96B raw, 112B comp, 8 pages, encodings: [BIT_PACKED, RLE, PLAIN_DICTIONARY], dic &#123; 1 entries, 8B raw, 1B comp&#125;</span><br><span class="line">Dec 11, 2020 4:08:55 PM INFO: org.apache.parquet.hadoop.ColumnChunkPageWriteStore: written 6,496,780B for [update_time] BINARY: 1,035,273 values, 22,843,365B raw, 6,495,172B comp, 23 pages, encodings: [BIT_PACKED, PLAIN, RLE, PLAIN_DICTIONARY], dic &#123; 27,530 entries, 633,190B raw, 27,530B comp&#125;</span><br><span class="line">Dec 11, 2020 4:08:55 PM INFO: org.apache.parquet.hadoop.ColumnChunkPageWriteStore: written 486,705B for [buyer_id] BINARY: 1,035,273 values, 1,757,571B raw, 486,033B comp, 14 pages, encodings: [BIT_PACKED, PLAIN, RLE, PLAIN_DICTIONARY], dic &#123; 72,340 entries, 980,153B raw, 72,340B comp&#125;</span><br><span class="line">Dec 11, 2020 4:08:55 PM INFO: org.apache.parquet.hadoop.ColumnChunkPageWriteStore: written 1,248,275B for [seller_id] INT32: 1,035,273 values, 1,440,252B raw, 1,248,119B comp, 4 pages, encodings: [BIT_PACKED, RLE, PLAIN_DICTIONARY], dic &#123; 112,471 entries, 449,884B raw, 112,471B comp&#125;</span><br><span class="line">Dec 11, 2020 4:08:55 PM INFO: org.apache.parquet.hadoop.ColumnChunkPageWriteStore: written 164,710B for [f_seller_id] INT32: 1,035,273 values, 251,370B raw, 164,554B comp, 4 pages, encodings: [BIT_PACKED, RLE, PLAIN_DICTIONARY], dic &#123; 12,392 entries, 49,568B raw, 12,392B comp&#125;</span><br><span class="line">Dec 11, 2020 4:08:55 PM INFO: org.apache.parquet.hadoop.ColumnChunkPageWriteStore: written 149,608B for [status] INT32: 1,035,273 values, 158,031B raw, 149,452B comp, 4 pages, encodings: [BIT_PACKED, RLE, PLAIN_DICTIONARY], dic &#123; 3 entries, 12B raw, 3B comp&#125;</span><br><span class="line">Dec 11, 2020 4:08:55 PM INFO: org.apache.parquet.hadoop.ColumnChunkPageWriteStore: written 456B for [rate_fund] INT64: 1,035,273 values, 96B raw, 112B comp, 8 pages, encodings: [BIT_PACKED, RLE, PLAIN_DICTIONARY], dic &#123; 1 entries, 8B raw, 1B comp&#125;</span><br><span class="line">Dec 11, 2020 4:08:55 PM INFO: org.apache.parquet.hadoop.ColumnChunkPageWriteStore: written 169,390B for [version_id] INT32: 1,035,273 values, 231,460B raw, 169,234B comp, 4 pages, encodings: [BIT_PACKED, RLE, PLAIN_DICTIONARY], dic &#123; 13 entries, 52B raw, 13B comp&#125;</span><br><span class="line">Dec 11, 2020 4:08:55 PM INFO: org.apache.parquet.hadoop.ColumnChunkPageWriteStore: written 67,464B for [refund_status] INT32: 1,035,273 values, 89,951B raw, 67,308B comp, 4 pages, encodings: [BIT_PACKED, RLE, PLAIN_DICTIONARY], dic &#123; 4 entries, 16B raw, 4B comp&#125;</span><br></pre></td></tr></table></figure>



<h5 id="b-mr"><a href="#b-mr" class="headerlink" title="b) mr"></a>b) mr</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">Dec 11, 2020 12:09:45 AM INFO: org.apache.parquet.hadoop.codec.CodecConfig: Compression: SNAPPY</span><br><span class="line">Dec 11, 2020 12:09:45 AM INFO: org.apache.parquet.hadoop.ParquetOutputFormat: Parquet block size to 134217728</span><br><span class="line">Dec 11, 2020 12:09:45 AM INFO: org.apache.parquet.hadoop.ParquetOutputFormat: Parquet page size to 1048576</span><br><span class="line">Dec 11, 2020 12:09:45 AM INFO: org.apache.parquet.hadoop.ParquetOutputFormat: Parquet dictionary page size to 1048576</span><br><span class="line">Dec 11, 2020 12:09:45 AM INFO: org.apache.parquet.hadoop.ParquetOutputFormat: Dictionary is on</span><br><span class="line">Dec 11, 2020 12:09:45 AM INFO: org.apache.parquet.hadoop.ParquetOutputFormat: Validation is off</span><br><span class="line">Dec 11, 2020 12:09:45 AM INFO: org.apache.parquet.hadoop.ParquetOutputFormat: Writer version is: PARQUET_1_0</span><br><span class="line">Dec 11, 2020 12:09:45 AM INFO: org.apache.parquet.hadoop.ParquetOutputFormat: Maximum row group padding size is 0 bytes</span><br><span class="line">Dec 11, 2020 12:10:01 AM INFO: org.apache.parquet.hadoop.InternalParquetRecordWriter: mem size 134,596,338 &gt; 134,217,728: flushing 679,290 records to disk.</span><br><span class="line">Dec 11, 2020 12:10:01 AM INFO: org.apache.parquet.hadoop.InternalParquetRecordWriter: Flushing mem columnStore to file. allocated memory: 135,665,494</span><br><span class="line">Dec 11, 2020 12:10:01 AM INFO: org.apache.parquet.hadoop.ColumnChunkPageWriteStore: written 84,603B for [auto_id] INT64: 679,290 values, 84,384B raw, 84,323B comp, 6 pages, encodings: [BIT_PACKED, RLE, PLAIN_DICTIONARY], dic &#123; 22,331 entries, 178,648B raw, 22,331B comp&#125;</span><br><span class="line">Dec 11, 2020 12:10:02 AM INFO: org.apache.parquet.hadoop.ColumnChunkPageWriteStore: written 5,121,794B for [id] INT64: 679,290 values, 5,434,368B raw, 5,121,507B comp, 6 pages, encodings: [BIT_PACKED, RLE, PLAIN]</span><br><span class="line">Dec 11, 2020 12:10:02 AM INFO: org.apache.parquet.hadoop.ColumnChunkPageWriteStore: written 4,114,386B for [item_id] INT64: 679,290 values, 5,434,368B raw, 4,114,099B comp, 6 pages, encodings: [BIT_PACKED, RLE, PLAIN]</span><br><span class="line">Dec 11, 2020 12:10:02 AM INFO: org.apache.parquet.hadoop.ColumnChunkPageWriteStore: written 1,140,171B for [price] BINARY: 679,290 values, 1,158,473B raw, 1,139,909B comp, 6 pages, encodings: [BIT_PACKED, RLE, PLAIN_DICTIONARY], dic &#123; 12,680 entries, 123,547B raw, 12,680B comp&#125;</span><br><span class="line">Dec 11, 2020 12:10:02 AM INFO: org.apache.parquet.hadoop.ColumnChunkPageWriteStore: written 281,422B for [quantity] INT64: 679,290 values, 643,817B raw, 281,140B comp, 6 pages, encodings: [BIT_PACKED, RLE, PLAIN_DICTIONARY], dic &#123; 1,213 entries, 9,704B raw, 1,213B comp&#125;</span><br><span class="line">Dec 11, 2020 12:10:02 AM INFO: org.apache.parquet.hadoop.ColumnChunkPageWriteStore: written 1,225,975B for [total_price] BINARY: 679,290 values, 1,243,295B raw, 1,225,712B comp, 6 pages, encodings: [BIT_PACKED, RLE, PLAIN_DICTIONARY], dic &#123; 27,429 entries, 269,122B raw, 27,429B comp&#125;</span><br><span class="line">Dec 11, 2020 12:10:02 AM INFO: org.apache.parquet.hadoop.ColumnChunkPageWriteStore: written 1,977B for [cps_fee] BINARY: 679,290 values, 2,390B raw, 1,760B comp, 6 pages, encodings: [BIT_PACKED, RLE, PLAIN_DICTIONARY], dic &#123; 165 entries, 1,357B raw, 165B comp&#125;</span><br><span class="line">Dec 11, 2020 12:10:02 AM INFO: org.apache.parquet.hadoop.ColumnChunkPageWriteStore: written 2,572,263B for [item_sku_id] INT64: 679,290 values, 4,662,155B raw, 2,571,977B comp, 6 pages, encodings: [BIT_PACKED, RLE, PLAIN, PLAIN_DICTIONARY], dic &#123; 70,731 entries, 565,848B raw, 70,731B comp&#125;</span><br><span class="line">Dec 11, 2020 12:10:02 AM INFO: org.apache.parquet.hadoop.ColumnChunkPageWriteStore: written 6,933,270B for [add_time] BINARY: 679,290 values, 15,623,790B raw, 6,932,221B comp, 15 pages, encodings: [BIT_PACKED, RLE, PLAIN]</span><br><span class="line">Dec 11, 2020 12:10:02 AM INFO: org.apache.parquet.hadoop.ColumnChunkPageWriteStore: written 5,037,909B for [order_id] INT64: 679,290 values, 5,434,368B raw, 5,037,622B comp, 6 pages, encodings: [BIT_PACKED, RLE, PLAIN]</span><br><span class="line">Dec 11, 2020 12:10:02 AM INFO: org.apache.parquet.hadoop.ColumnChunkPageWriteStore: written 332B for [sk] BINARY: 679,290 values, 117B raw, 123B comp, 3 pages, encodings: [BIT_PACKED, RLE, PLAIN_DICTIONARY], dic &#123; 9 entries, 548B raw, 9B comp&#125;</span><br><span class="line">Dec 11, 2020 12:10:02 AM INFO: org.apache.parquet.hadoop.ColumnChunkPageWriteStore: written 5,675,428B for [item_sku_title] BINARY: 679,290 values, 7,868,590B raw, 5,674,984B comp, 9 pages, encodings: [BIT_PACKED, RLE, PLAIN, PLAIN_DICTIONARY], dic &#123; 30,819 entries, 729,235B raw, 30,819B comp&#125;</span><br><span class="line">Dec 11, 2020 12:10:02 AM INFO: org.apache.parquet.hadoop.ColumnChunkPageWriteStore: written 34,917,594B for [item_title] BINARY: 679,290 values, 41,284,243B raw, 34,910,519B comp, 41 pages, encodings: [BIT_PACKED, RLE, PLAIN, PLAIN_DICTIONARY], dic &#123; 15,403 entries, 1,011,183B raw, 15,403B comp&#125;</span><br><span class="line">Dec 11, 2020 12:10:02 AM INFO: org.apache.parquet.hadoop.ColumnChunkPageWriteStore: written 27,409,350B for [img_head] BINARY: 679,290 values, 41,769,032B raw, 27,405,580B comp, 41 pages, encodings: [BIT_PACKED, RLE, PLAIN, PLAIN_DICTIONARY], dic &#123; 15,612 entries, 1,014,148B raw, 15,612B comp&#125;</span><br><span class="line">Dec 11, 2020 12:10:02 AM INFO: org.apache.parquet.hadoop.ColumnChunkPageWriteStore: written 16,932,320B for [extend] BINARY: 679,290 values, 42,638,909B raw, 16,930,559B comp, 42 pages, encodings: [BIT_PACKED, RLE, PLAIN, PLAIN_DICTIONARY], dic &#123; 17,372 entries, 1,008,909B raw, 17,372B comp&#125;</span><br><span class="line">Dec 11, 2020 12:10:02 AM INFO: org.apache.parquet.hadoop.ColumnChunkPageWriteStore: written 342B for [data_ver] INT64: 679,290 values, 72B raw, 84B comp, 6 pages, encodings: [BIT_PACKED, RLE, PLAIN_DICTIONARY], dic &#123; 1 entries, 8B raw, 1B comp&#125;</span><br><span class="line">Dec 11, 2020 12:10:02 AM INFO: org.apache.parquet.hadoop.ColumnChunkPageWriteStore: written 6,800,709B for [update_time] BINARY: 679,290 values, 15,623,790B raw, 6,799,660B comp, 15 pages, encodings: [BIT_PACKED, RLE, PLAIN]</span><br><span class="line">Dec 11, 2020 12:10:02 AM INFO: org.apache.parquet.hadoop.ColumnChunkPageWriteStore: written 6,194,701B for [buyer_id] BINARY: 679,290 values, 9,200,418B raw, 6,194,344B comp, 9 pages, encodings: [BIT_PACKED, RLE, PLAIN]</span><br><span class="line">Dec 11, 2020 12:10:02 AM INFO: org.apache.parquet.hadoop.ColumnChunkPageWriteStore: written 1,464,540B for [seller_id] INT32: 679,290 values, 1,464,273B raw, 1,464,423B comp, 3 pages, encodings: [BIT_PACKED, RLE, PLAIN_DICTIONARY], dic &#123; 131,083 entries, 524,332B raw, 131,083B comp&#125;</span><br><span class="line">Dec 11, 2020 12:10:02 AM INFO: org.apache.parquet.hadoop.ColumnChunkPageWriteStore: written 295,854B for [f_seller_id] INT32: 679,290 values, 550,175B raw, 295,737B comp, 3 pages, encodings: [BIT_PACKED, RLE, PLAIN_DICTIONARY], dic &#123; 16,979 entries, 67,916B raw, 16,979B comp&#125;</span><br><span class="line">Dec 11, 2020 12:10:02 AM INFO: org.apache.parquet.hadoop.ColumnChunkPageWriteStore: written 152,287B for [status] INT32: 679,290 values, 161,460B raw, 152,170B comp, 3 pages, encodings: [BIT_PACKED, RLE, PLAIN_DICTIONARY], dic &#123; 3 entries, 12B raw, 3B comp&#125;</span><br><span class="line">Dec 11, 2020 12:10:02 AM INFO: org.apache.parquet.hadoop.ColumnChunkPageWriteStore: written 342B for [rate_fund] INT64: 679,290 values, 72B raw, 84B comp, 6 pages, encodings: [BIT_PACKED, RLE, PLAIN_DICTIONARY], dic &#123; 1 entries, 8B raw, 1B comp&#125;</span><br><span class="line">Dec 11, 2020 12:10:02 AM INFO: org.apache.parquet.hadoop.ColumnChunkPageWriteStore: written 226,851B for [version_id] INT32: 679,290 values, 309,556B raw, 226,734B comp, 3 pages, encodings: [BIT_PACKED, RLE, PLAIN_DICTIONARY], dic &#123; 16 entries, 64B raw, 16B comp&#125;</span><br><span class="line">Dec 11, 2020 12:10:02 AM INFO: org.apache.parquet.hadoop.ColumnChunkPageWriteStore: written 65,837B for [refund_status] INT32: 679,290 values, 101,856B raw, 65,720B comp, 3 pages, encodings: [BIT_PACKED, RLE, PLAIN_DICTIONARY], dic &#123; 4 entries, 16B raw, 4B comp&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到 parquet.block.size 、page.size 、 dictionary.page.size 这些参数都一样的情况下，在一个 rowgroup 中 mr 能写入的数据少于 outscan 能写入的数据，这就是因为压缩率不同导致的。</p>
<h4 id="3、查看源码"><a href="#3、查看源码" class="headerlink" title="3、查看源码"></a>3、查看源码</h4><h5 id="a-snappy"><a href="#a-snappy" class="headerlink" title="a) snappy"></a>a) snappy</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">org.apache.parquet.hadoop.CodecFactory.BytesCompressor#compress  public BytesInput compress(BytesInput bytes) throws IOException &#123;  final BytesInput compressedBytes;  if (codec &#x3D;&#x3D; null) &#123;    compressedBytes &#x3D; bytes;  &#125; else &#123;    compressedOutBuffer.reset();    if (compressor !&#x3D; null) &#123;      &#x2F;&#x2F; null compressor for non-native gzip      compressor.reset();    &#125;    CompressionOutputStream cos &#x3D; codec.createOutputStream(compressedOutBuffer, compressor);    bytes.writeAllTo(cos);    cos.finish();    cos.close();    compressedBytes &#x3D; BytesInput.from(compressedOutBuffer);  &#125;  return compressedBytes; &#125;  org.apache.parquet.hadoop.codec.SnappyCompressor#compress  @Override public synchronized int compress(byte[] buffer, int off, int len) throws IOException &#123;  SnappyUtil.validateBuffer(buffer, off, len);   if (needsInput()) &#123;    &#x2F;&#x2F; No buffered output bytes and no input to consume, need more input    return 0;  &#125;   if (!outputBuffer.hasRemaining()) &#123;    &#x2F;&#x2F; There is uncompressed input, compress it now    int maxOutputSize &#x3D; Snappy.maxCompressedLength(inputBuffer.position());    if (maxOutputSize &gt; outputBuffer.capacity()) &#123;      outputBuffer &#x3D; ByteBuffer.allocateDirect(maxOutputSize);    &#125;    &#x2F;&#x2F; Reset the previous outputBuffer    outputBuffer.clear();    inputBuffer.limit(inputBuffer.position());    inputBuffer.position(0);     int size &#x3D; Snappy.compress(inputBuffer, outputBuffer);    outputBuffer.limit(size);    inputBuffer.limit(0);    inputBuffer.rewind();  &#125;   &#x2F;&#x2F; Return compressed output up to &#39;len&#39;  int numBytes &#x3D; Math.min(len, outputBuffer.remaining());  outputBuffer.get(buffer, off, numBytes);      bytesWritten +&#x3D; numBytes;  return numBytes;      &#125;  org.xerial.snappy.Snappy#compress(java.nio.ByteBuffer, java.nio.ByteBuffer)  public static int compress(ByteBuffer uncompressed, ByteBuffer compressed) throws IOException &#123;     if (!uncompressed.isDirect())        throw new SnappyError(SnappyErrorCode.NOT_A_DIRECT_BUFFER, &quot;input is not a direct buffer&quot;);    if (!compressed.isDirect())        throw new SnappyError(SnappyErrorCode.NOT_A_DIRECT_BUFFER, &quot;destination is not a direct buffer&quot;);     &#x2F;&#x2F; input: uncompressed[pos(), limit())    &#x2F;&#x2F; output: compressed    int uPos &#x3D; uncompressed.position();    int uLen &#x3D; uncompressed.remaining();    int compressedSize &#x3D; ((SnappyNativeAPI) impl).rawCompress(uncompressed, uPos, uLen, compressed,            compressed.position());     &#x2F;&#x2F;         pos  limit    &#x2F;&#x2F; [ ......BBBBBBB.........]    compressed.limit(compressed.position() + compressedSize);     return compressedSize; &#125;</span><br></pre></td></tr></table></figure>

<p>上面是 snappy 压缩的过程，可以看到 snappy 对输入的流除了不能超过 Integer.MAXVALUE，其他没有做什么限制。也就是输入什么，它就按它的逻辑去压缩什么。parquet 获取到压缩后的流写入内存 page 中。</p>
<p>因此推测问题应该不在 snappy 这边。</p>
<h5 id="b-parquet"><a href="#b-parquet" class="headerlink" title="b) parquet"></a>b) parquet</h5><p>parquet 源码我就不复制过来了，有点多。 parquet 也只是获取到 reduce 的输出流，对数据根据类型和内容进行不同的编码，然后形成它的数据结构再用 snappy 进行压缩，再输出到文件。</p>
<p>需要注意的是 parquet.dictionary.page.size 这个参数会对编码造成一定影响，当 dictionary 里的值大于配置的值，编码会退化。</p>
<h5 id="c-mapreduce"><a href="#c-mapreduce" class="headerlink" title="c) mapreduce"></a>c) mapreduce</h5><p>重点怀疑是在 reduce 后或者过程中，输出数据之间较为稀疏，导致压缩效率不理想。但是这块不是非常熟悉，需要找方法验证。</p>
<h3 id="三、结果"><a href="#三、结果" class="headerlink" title="三、结果"></a>三、结果</h3><p>已经找到原因，确实是 reduce 后数据较为稀疏导致压缩率不高。</p>
<p>前天在排查的时候，发现 outscan 出来的数据某些 ID 都是连续的，而后面的 title 数据会有基本相同的数据排在一起。怀疑某些表的数据有特殊性，在 ID 连续时，其他列的数据基本相同。后续也证实了这个猜想。</p>
<p>当某些表的 xxx_id 连续分布在同一个 reduce 中时，会对压缩率有极大的提高，例如</p>
<p>| item_sku_id| title |<br>| 11231 | 黑色羊毛衫XL|<br>| 11232 | 黑色羊毛衫XXL|</p>
<p>| 11233 | 遥控汽车A |</p>
<p>| 11234 | 遥控汽车B |</p>
<p> 默认的 partition 会将 11231，11233发送到 reduce A , 11232 ，11234 发送到 reduce B,最后产生两个内容基本没有重复的文件，会导致数据不连续 压缩率不理想。</p>
<p>而 outscan 没有 reduce 的过程，直接 map 完有序输出，不会将连续的 id 切分到各个 reduce。</p>
<p>解决办法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public int getPartition(Text text, Text value, int numPartitions) &#123;    long key &#x3D; Long.parseLong((text.toString().split(&quot;_&quot;))[0]);    return (int) (key&#x2F;100%numPartitions); &#125;</span><br></pre></td></tr></table></figure>

<p>增加了一个 partition，专门给这些数据上有连续性的表用，将连续的 ID 发送到同一个 reduce 输出。sub最后两位是观察我们DB里的数据的连续性得出的经验值。</p>
<h3 id="四、解决问题之外的研究"><a href="#四、解决问题之外的研究" class="headerlink" title="四、解决问题之外的研究"></a>四、解决问题之外的研究</h3><p>最后研究下 parquet 的编码对 parquet 本身压缩率有多大的影响。</p>
<p>开启 SNAPPY 压缩，自定义分区方式重跑 ods_itm_wd_inv_app_item_sku_d 任务结果体积大小及编码结果</p>
<p><img src="https://cdn.jsdelivr.net/gh/xingcici/oss@master/uPic/image-20210127165125612.png" alt="image-20210127165125612"></p>
<p><img src="https://cdn.jsdelivr.net/gh/xingcici/oss@master/uPic/image-20210127165142007.png" alt="image-20210127165142007"></p>
<p>关闭SNAPPY压缩后，自定义分区方式重新跑 ods_itm_wd_inv_app_item_sku_d 任务结果体积大小及编码结果。</p>
<p><img src="https://cdn.jsdelivr.net/gh/xingcici/oss@master/uPic/image-20210127165848742.png" alt="image-20210127165848742"></p>
<p><img src="https://cdn.jsdelivr.net/gh/xingcici/oss@master/uPic/image-20210127165221964.png" alt="image-20210127165221964"></p>
<p>关闭SNAPPY压缩后，默认分区方式重新跑 ods_itm_wd_inv_app_item_sku_d 任务结果体积大小及编码结果。</p>
<p><img src="https://cdn.jsdelivr.net/gh/xingcici/oss@master/uPic/image-20210127165830347.png" alt="image-20210127165830347"></p>
<p><img src="https://cdn.jsdelivr.net/gh/xingcici/oss@master/uPic/image-20210127165246366.png" alt="image-20210127165246366"></p>
<p>根据上面的数据可以得出，在数据密集的情况下，parquet 本身对数据的压缩率就会高一些，在数据不密集的情况下 5.1T ，数据密集的情况下 3.7T。</p>
<p>下面两张图可以看到，有序和无序对都是字符的 title 列的编码方式影响不大，都用PLAIN编码。</p>
<p><img src="https://cdn.jsdelivr.net/gh/xingcici/oss@master/uPic/image-20210127165814330.png" alt="image-20210127165814330"></p>
<p><img src="https://cdn.jsdelivr.net/gh/xingcici/oss@master/uPic/image-20210127165310098.png" alt="image-20210127165310098"></p>

      
    </div>
    <div class="article-footer">
      <blockquote class="mt-2x">
  <ul class="post-copyright list-unstyled">
    
    <li class="post-copyright-link hidden-xs">
      <strong>本文链接：</strong>
      <a href="http://xingcici.github.io/2021/01/27/mr-output-data-volume-becomes-larger.html" title="MR产出数据体积变大问题" target="_blank" rel="external">http://xingcici.github.io/2021/01/27/mr-output-data-volume-becomes-larger.html</a>
    </li>
    
    <li class="post-copyright-license">
      <strong>版权声明： </strong> 本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN协议</a> 许可协议。转载请注明出处！
    </li>
  </ul>
</blockquote>


<div class="panel panel-default panel-badger">
  <div class="panel-body">
    <figure class="media">
      <div class="media-left">
        <a href="https://github.com/xingcici" target="_blank" class="img-burn thumb-sm visible-lg">
          <img src="/images/avatar.jpg" class="img-rounded w-full" alt="">
        </a>
      </div>
      <div class="media-body">
        <h3 class="media-heading"><a href="https://github.com/xingcici" target="_blank"><span class="text-dark">行词</span><small class="ml-1x">中间件</small></a></h3>
        <div>混迹互联网行业将近三年，业务和中间件都有涉猎，目前专注于中间件领域。欢迎探讨问题，联系邮箱 haifeng.pang@foxmail.com。</div>
      </div>
    </figure>
  </div>
</div>


    </div>
  </article>
  
    
  <section id="comments">
  	
      <div id="vcomments"></div>
    
  </section>


  
</div>

  <nav class="bar bar-footer clearfix" data-stick-bottom>
  <div class="bar-inner">
  
  <ul class="pager pull-left">
    
    <li class="prev">
      <a href="/2021/01/27/decentralized-message-queue-meta-mq.html" title="去中心化消息队列 Meta MQ"><i class="icon icon-angle-left" aria-hidden="true"></i><span>&nbsp;&nbsp;上一篇</span></a>
    </li>
    
    
    <li class="next">
      <a href="/2020/09/10/skywalking-660-compatibility-issues-with-arthas.html" title="Skywalking 6.6.0对arthas的兼容性问题"><span>下一篇&nbsp;&nbsp;</span><i class="icon icon-angle-right" aria-hidden="true"></i></a>
    </li>
    
    
  </ul>
  
  
  
  <div class="bar-right">
    
    <div class="share-component" data-sites="weibo,qq,wechat,facebook,twitter" data-mobile-sites="weibo,qq,qzone"></div>
    
  </div>
  </div>
</nav>
  


</main>

  <footer class="footer" itemscope itemtype="http://schema.org/WPFooter">
	
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/xingcici" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
        <li><a href="/atom.xml" target="_blank" title="Rss" data-toggle=tooltip data-placement=top><i class="icon icon-rss"></i></a></li>
        
    </ul>

    <div class="copyright">
    	
        &copy; 2021 行词
        
        <div class="publishby">
        	Theme by <a href="https://github.com/cofess" target="_blank"> cofess </a>base on <a href="https://github.com/cofess/hexo-theme-pure" target="_blank">pure</a>.
        </div>
    </div>
</footer>
  <script src="//cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script>
<script>
window.jQuery || document.write('<script src="js/jquery.min.js"><\/script>')
</script>

<script src="/js/plugin.min.js"></script>


<script src="/js/application.js"></script>


    <script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(未命名)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>

<script src="/js/insight.js"></script>






   
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>





   
    
  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/valine"></script>
  <script type="text/javascript">
  var GUEST = ['nick', 'mail', 'link'];
  var meta = 'nick,mail,link';
  meta = meta.split(',').filter(function(item) {
    return GUEST.indexOf(item) > -1;
  });
  new Valine({
    el: '#vcomments',
    verify: false,
    notify: true,
    appId: 'x9owKjybloVuPGfhRfqicCp7-gzGzoHsz',
    appKey: 'latjez4p0BqCqKM14wXbCg0b',
    placeholder: '欢迎交流~',
    avatar: 'mm',
    meta: meta,
    pageSize: '10' || 10,
    visitor: false
  });
  </script>

     







</body>
</html>